<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能家居设备模拟器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-house-door"></i> 智能家居设备模拟器
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">添加新设备</h5>
                        <form id="addDeviceForm" class="row g-3">
                            <div class="col-md-5">
                                <select class="form-select" id="deviceType" required>
                                    <option value="">选择设备类型...</option>
                                    {% for type in device_types %}
                                    <option value="{{ type }}">{{ type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control" id="deviceId" placeholder="设备ID (例如: light-001)" required>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">添加</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="deviceList">
            <!-- 设备卡片将在这里动态添加 -->
        </div>
    </div>

    <!-- 设备控制模态框 -->
    <div class="modal fade" id="controlModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">设备控制</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="controlModalBody">
                    <!-- 控制选项将在这里动态添加 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 设备状态更新间隔（毫秒）
        const UPDATE_INTERVAL = 2000;
        
        // 设备控制命令模板
        const deviceCommands = {
            light: [
                { command: 'turn_on', label: '开启', class: 'btn-success' },
                { command: 'turn_off', label: '关闭', class: 'btn-danger' },
                { command: 'set_brightness', label: '设置亮度', type: 'range', min: 0, max: 100 }
            ],
            thermostat: [
                { command: 'set_target_temp', label: '设置目标温度', type: 'number', min: 16, max: 30 }
            ],
            doorlock: [
                { command: 'lock', label: '上锁', class: 'btn-warning' },
                { command: 'unlock', label: '解锁', class: 'btn-success' }
            ],
            blind: [
                { command: 'open', label: '打开', class: 'btn-success' },
                { command: 'close', label: '关闭', class: 'btn-danger' },
                { command: 'set_position', label: '设置位置', type: 'range', min: 0, max: 100 }
            ],
            ac: [
                { command: 'turn_on', label: '开启', class: 'btn-success' },
                { command: 'turn_off', label: '关闭', class: 'btn-danger' },
                { command: 'set_temp', label: '设置温度', type: 'number', min: 16, max: 30 }
            ],
            smoke_detector: [
                { command: 'reset', label: '重置报警', class: 'btn-warning' }
            ],
            fan: [
                { command: 'turn_on', label: '开启', class: 'btn-success' },
                { command: 'turn_off', label: '关闭', class: 'btn-danger' },
                { command: 'set_speed', label: '设置风速', type: 'range', min: 1, max: 3 }
            ],
            plug: [
                { command: 'turn_on', label: '开启', class: 'btn-success' },
                { command: 'turn_off', label: '关闭', class: 'btn-danger' }
            ]
        };

        // 更新设备列表
        function updateDeviceList() {
            fetch('/api/devices')
                .then(response => response.json())
                .then(devices => {
                    const deviceList = document.getElementById('deviceList');
                    deviceList.innerHTML = '';
                    
                    Object.entries(devices).forEach(([id, device]) => {
                        const card = createDeviceCard(id, device);
                        deviceList.appendChild(card);
                    });
                });
        }

        // 创建设备卡片
        function createDeviceCard(id, device) {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';
            
            const card = document.createElement('div');
            card.className = 'card device-card';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // 设备标题
            const title = document.createElement('h5');
            title.className = 'card-title';
            title.innerHTML = `
                <span class="status-indicator status-online"></span>
                ${id}
                <small class="text-muted">(${device.type})</small>
            `;
            
            // 设备状态
            const status = document.createElement('div');
            status.className = 'card-text';
            status.innerHTML = formatDeviceStatus(device);
            
            // 控制按钮
            const controls = document.createElement('div');
            controls.className = 'mt-3';
            const controlBtn = document.createElement('button');
            controlBtn.className = 'btn btn-primary btn-sm';
            controlBtn.textContent = '控制';
            controlBtn.onclick = () => showControlModal(id, device.type);
            
            // 删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm ms-2';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => deleteDevice(id);
            
            controls.appendChild(controlBtn);
            controls.appendChild(deleteBtn);
            
            cardBody.appendChild(title);
            cardBody.appendChild(status);
            cardBody.appendChild(controls);
            card.appendChild(cardBody);
            col.appendChild(card);
            
            return col;
        }

        // 格式化设备状态显示
        function formatDeviceStatus(device) {
            const status = [];
            for (const [key, value] of Object.entries(device)) {
                if (key !== 'type') {
                    status.push(`${key}: ${value}`);
                }
            }
            return status.join('<br>');
        }

        // 显示控制模态框
        function showControlModal(deviceId, deviceType) {
            const modalBody = document.getElementById('controlModalBody');
            modalBody.innerHTML = '';
            
            const commands = deviceCommands[deviceType] || [];
            commands.forEach(cmd => {
                const controlDiv = document.createElement('div');
                controlDiv.className = 'mb-3';
                
                if (cmd.type) {
                    // 创建带输入框的控制
                    const label = document.createElement('label');
                    label.className = 'form-label';
                    label.textContent = cmd.label;
                    
                    const input = document.createElement('input');
                    input.type = cmd.type;
                    input.className = 'form-control';
                    input.min = cmd.min;
                    input.max = cmd.max;
                    
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary mt-2';
                    button.textContent = '应用';
                    button.onclick = () => sendCommand(deviceId, {
                        command: cmd.command,
                        [cmd.command.split('_')[1]]: input.value
                    });
                    
                    controlDiv.appendChild(label);
                    controlDiv.appendChild(input);
                    controlDiv.appendChild(button);
                } else {
                    // 创建按钮控制
                    const button = document.createElement('button');
                    button.className = `btn ${cmd.class || 'btn-primary'} w-100`;
                    button.textContent = cmd.label;
                    button.onclick = () => sendCommand(deviceId, { command: cmd.command });
                    controlDiv.appendChild(button);
                }
                
                modalBody.appendChild(controlDiv);
            });
            
            new bootstrap.Modal(document.getElementById('controlModal')).show();
        }

        // 发送设备命令
        function sendCommand(deviceId, command) {
            fetch(`/api/devices/${deviceId}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(command)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                }
                updateDeviceList();
            });
        }

        // 删除设备
        function deleteDevice(deviceId) {
            if (confirm('确定要删除这个设备吗？')) {
                fetch(`/api/devices/${deviceId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    }
                    updateDeviceList();
                });
            }
        }

        // 添加设备
        document.getElementById('addDeviceForm').onsubmit = function(e) {
            e.preventDefault();
            
            const deviceType = document.getElementById('deviceType').value;
            const deviceId = document.getElementById('deviceId').value;
            
            fetch('/api/devices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: deviceType,
                    id: deviceId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('addDeviceForm').reset();
                    updateDeviceList();
                }
            });
        };

        // 定期更新设备列表
        setInterval(updateDeviceList, UPDATE_INTERVAL);
        updateDeviceList();
    </script>
</body>
</html> 